{% extends "base.html" %}

{% block title %}Query History - SQL Visualizer{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-history"></i> Query History
                    <small class="text-muted">Your SQL learning journey</small>
                </h2>
                
                <div class="btn-group">
                    <a href="{{ url_for('main.sql_playground') }}" class="btn btn-primary">
                        <i class="fas fa-play"></i> New Query
                    </a>
                    <button type="button" class="btn btn-outline-secondary" onclick="exportHistory()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-3">
                            <label for="queryTypeFilter" class="form-label">Query Type</label>
                            <select class="form-select" id="queryTypeFilter">
                                <option value="">All Types</option>
                                <option value="SELECT">SELECT</option>
                                <option value="INSERT">INSERT</option>
                                <option value="UPDATE">UPDATE</option>
                                <option value="DELETE">DELETE</option>
                                <option value="CREATE">CREATE</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="statusFilter" class="form-label">Status</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="success">Successful</option>
                                <option value="error">With Errors</option>
                                <option value="ai_assisted">AI Assisted</option>
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="searchQuery" class="form-label">Search</label>
                            <input type="text" class="form-control" id="searchQuery" 
                                   placeholder="Search in query text...">
                        </div>
                        
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-primary w-100" onclick="applyFilters()">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Query List -->
    <div class="row">
        <div class="col-12">
            {% if queries.items %}
                <div class="card shadow-sm">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Query</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Results</th>
                                        <th>Execution Time</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for query in queries.items %}
                                    <tr class="query-row" data-query-id="{{ query.id }}">
                                        <td>
                                            <div class="query-preview">
                                                <code class="small">
                                                    {{ query.query_text[:80] }}{% if query.query_text|length > 80 %}...{% endif %}
                                                </code>
                                                {% if query.query_text|length > 80 %}
                                                <button type="button" class="btn btn-link btn-sm p-0 ms-1" 
                                                        data-bs-toggle="tooltip" 
                                                        title="Click to view full query"
                                                        onclick="showFullQuery('{{ query.id }}')">
                                                    <i class="fas fa-expand-alt"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                        
                                        <td>
                                            <span class="badge bg-{{ 'primary' if query.query_type == 'SELECT' 
                                                                     else 'success' if query.query_type in ['INSERT', 'UPDATE'] 
                                                                     else 'warning' if query.query_type == 'DELETE'
                                                                     else 'info' if query.query_type == 'CREATE'
                                                                     else 'secondary' }}">
                                                {{ query.query_type }}
                                            </span>
                                        </td>
                                        
                                        <td>
                                            {% if query.error_message %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-exclamation-triangle"></i> Error
                                                </span>
                                            {% else %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check-circle"></i> Success
                                                </span>
                                            {% endif %}
                                        </td>
                                        
                                        <td>
                                            <span class="text-muted">
                                                {{ query.result_count or 0 }} 
                                                {% if query.result_count == 1 %}row{% else %}rows{% endif %}
                                            </span>
                                        </td>
                                        
                                        <td>
                                            <span class="text-muted small">
                                                {% if query.execution_time %}
                                                    {{ "%.3f"|format(query.execution_time) }}s
                                                {% else %}
                                                    --
                                                {% endif %}
                                            </span>
                                        </td>
                                        
                                        <td>
                                            <span class="text-muted small">
                                                {{ query.created_at.strftime('%m/%d/%Y %H:%M') }}
                                            </span>
                                        </td>
                                        
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary btn-sm" 
                                                        onclick="viewQueryDetails('{{ query.id }}')"
                                                        data-bs-toggle="tooltip" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                
                                                <button type="button" class="btn btn-outline-success btn-sm" 
                                                        onclick="runQueryAgain('{{ query.id }}')"
                                                        data-bs-toggle="tooltip" title="Run Again">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                                
                                                {% if not query.error_message and query.result_data %}
                                                <button type="button" class="btn btn-outline-info btn-sm" 
                                                        onclick="visualizeQuery('{{ query.id }}')"
                                                        data-bs-toggle="tooltip" title="Visualize">
                                                    <i class="fas fa-chart-bar"></i>
                                                </button>
                                                {% endif %}
                                                
                                                <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                        onclick="copyQuery('{{ query.id }}')"
                                                        data-bs-toggle="tooltip" title="Copy Query">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Pagination -->
                {% if queries.pages > 1 %}
                <div class="d-flex justify-content-center mt-4">
                    <nav aria-label="Query history pagination">
                        <ul class="pagination">
                            {% if queries.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('main.query_history', page=queries.prev_num) }}">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                            {% endif %}
                            
                            {% for page_num in queries.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num != queries.page %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('main.query_history', page=page_num) }}">
                                                {{ page_num }}
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                    {% endif %}
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if queries.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('main.query_history', page=queries.next_num) }}">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
                
            {% else %}
                <!-- Empty State -->
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-database fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">No queries in your history yet</h4>
                        <p class="text-muted">Start writing SQL queries to see them appear here!</p>
                        <a href="{{ url_for('main.sql_playground') }}" class="btn btn-primary">
                            <i class="fas fa-play"></i> Write Your First Query
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Query Details Modal -->
<div class="modal fade" id="queryDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Query Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="queryDetailsContent">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="runCurrentQueryAgain()">
                    <i class="fas fa-play"></i> Run Again
                </button>
                <button type="button" class="btn btn-primary" onclick="editInPlayground()">
                    <i class="fas fa-edit"></i> Edit in Playground
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Full Query Modal -->
<div class="modal fade" id="fullQueryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Full Query</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre><code id="fullQueryContent"></code></pre>
            </div>
        </div>
    </div>
</div>

<script>
// Store query data for actions
let queryData = {};

function showFullQuery(queryId) {
    const modal = new bootstrap.Modal(document.getElementById('fullQueryModal'));
    const content = document.getElementById('fullQueryContent');
    
    // Get full query text from the row (you'd normally fetch this via API)
    const row = document.querySelector(`[data-query-id="${queryId}"]`);
    const queryText = row.querySelector('code').textContent;
    
    content.textContent = queryText;
    modal.show();
}

async function viewQueryDetails(queryId) {
    const modal = new bootstrap.Modal(document.getElementById('queryDetailsModal'));
    const content = document.getElementById('queryDetailsContent');
    
    content.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
    modal.show();
    
    try {
        // Fetch query details (implement this endpoint)
        const response = await fetch(`/api/query-details/${queryId}`);
        const data = await response.json();
        
        if (data.error) {
            content.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            return;
        }
        
        // Store for actions
        queryData = data;
        
        // Build details HTML
        let html = `
            <div class="row">
                <div class="col-lg-8">
                    <h6>SQL Query:</h6>
                    <pre class="bg-light p-3 rounded"><code>${data.query_text}</code></pre>
                    
                    ${data.error_message ? `
                    <div class="alert alert-danger">
                        <h6>Error:</h6>
                        ${data.error_message}
                    </div>
                    ` : ''}
                    
                    ${data.result_data && data.result_data.length > 0 ? `
                    <h6>Results (${data.result_data.length} rows):</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    ${data.columns.map(col => `<th>${col}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${data.result_data.slice(0, 10).map(row => `
                                    <tr>
                                        ${data.columns.map(col => `<td>${row[col] || ''}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${data.result_data.length > 10 ? `<small class="text-muted">Showing first 10 of ${data.result_data.length} rows</small>` : ''}
                    </div>
                    ` : ''}
                </div>
                
                <div class="col-lg-4">
                    <h6>Execution Details:</h6>
                    <ul class="list-unstyled">
                        <li><strong>Type:</strong> ${data.query_type}</li>
                        <li><strong>Execution Time:</strong> ${data.execution_time ? (data.execution_time * 1000).toFixed(2) + 'ms' : 'N/A'}</li>
                        <li><strong>Result Count:</strong> ${data.result_count || 0} rows</li>
                        <li><strong>Executed:</strong> ${new Date(data.created_at).toLocaleString()}</li>
                    </ul>
                    
                    ${data.ai_assisted ? `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-robot"></i> AI Assistance</h6>
                        <p>This query was executed with AI assistance. Tables were automatically created.</p>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        content.innerHTML = html;
        
    } catch (error) {
        content.innerHTML = '<div class="alert alert-danger">Error loading query details</div>';
    }
}

function runQueryAgain(queryId) {
    const row = document.querySelector(`[data-query-id="${queryId}"]`);
    const queryText = row.querySelector('code').textContent;
    
    // Store in session storage and redirect to playground
    sessionStorage.setItem('sqlQuery', queryText);
    window.location.href = "{{ url_for('main.sql_playground') }}";
}

function runCurrentQueryAgain() {
    if (queryData.query_text) {
        sessionStorage.setItem('sqlQuery', queryData.query_text);
        window.location.href = "{{ url_for('main.sql_playground') }}";
    }
}

function editInPlayground() {
    runCurrentQueryAgain();
}

async function visualizeQuery(queryId) {
    try {
        const response = await fetch(`/get-query-visualization/${queryId}`);
        const vizData = await response.json();
        
        if (vizData.error) {
            showToast('Visualization error: ' + vizData.error, 'danger');
            return;
        }
        
        // Store visualization data and redirect
        sessionStorage.setItem('queryVisualization', JSON.stringify(vizData));
        window.location.href = "{{ url_for('main.sql_playground') }}#visualization";
        
    } catch (error) {
        showToast('Error loading visualization: ' + error.message, 'danger');
    }
}

function copyQuery(queryId) {
    const row = document.querySelector(`[data-query-id="${queryId}"]`);
    const queryText = row.querySelector('code').textContent;
    
    navigator.clipboard.writeText(queryText).then(function() {
        showToast('Query copied to clipboard!', 'success');
    }).catch(function(err) {
        showToast('Failed to copy query', 'danger');
    });
}

function applyFilters() {
    const queryType = document.getElementById('queryTypeFilter').value;
    const status = document.getElementById('statusFilter').value;
    const search = document.getElementById('searchQuery').value;
    
    const params = new URLSearchParams();
    if (queryType) params.append('type', queryType);
    if (status) params.append('status', status);
    if (search) params.append('search', search);
    
    window.location.search = params.toString();
}

function exportHistory() {
    // Implement export functionality
    showToast('Export functionality coming soon!', 'info');
}

function showToast(message, type) {
    // Use the utility function from main.js
    if (window.sqlVisualizerUtils && window.sqlVisualizerUtils.showToast) {
        window.sqlVisualizerUtils.showToast(message, type);
    } else {
        alert(message);
    }
}

// Load query from session storage if available (from "run again" action)
document.addEventListener('DOMContentLoaded', function() {
    const storedQuery = sessionStorage.getItem('sqlQuery');
    if (storedQuery && window.location.pathname.includes('playground')) {
        sessionStorage.removeItem('sqlQuery');
        // This would be handled in the playground script
    }
});
</script>
{% endblock %}
